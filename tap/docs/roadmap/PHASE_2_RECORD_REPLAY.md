# Phase 2 - Record & Replay（录制与回放?

## 阶段目标

> **让用户能"录一段操作、改一下、一键重?，把 tap ?重复?升级?宏工作室"?*

这是 tap 核心能力的奠基阶段：录制生成 Timeline，编辑调整节奏，回放执行?

## 前置条件

- Phase 1 已完成，安全停止机制稳定

## 功能范围

### Must（必做）

| 功能 | 说明 | 验收标准 |
|------|------|----------|
| **全局事件录制** | 录制鼠标（move/click/scroll? 键盘（keydown/keyup?| 支持 Win + mac |
| **事件时间?* | 每个事件记录相对时间（ms?| 精度 ?10ms |
| **录制控制** | Record / Pause / Stop | 三态切换正?|
| **录制结束生成 Timeline** | 生成可编辑的 Timeline 数据结构 | ?tap-core 数据模型一?|
| **Move 事件降噪** | 连续 move 采样/合并 | 可配置采样率（默?50ms?|
| **Timeline 列表视图** | 显示动作列表，支持选中/删除/禁用 | 基础编辑能力 |
| **动作延时调整** | 修改单个动作的延?| 支持 +/- 微调 |
| **回放引擎** | ?Timeline 执行 | 支持循环、倍?|
| **回放倍?* | 0.5x / 1x / 2x | 实际延时按比例缩?|
| **回放循环** | 执行 N ?/ Forever | 可配?|

### Should（强烈建议）

| 功能 | 说明 | 理由 |
|------|------|------|
| **录制?UI 反馈** | 显示录制时长、事件数、采样率 | 让用户知?在录" |
| **动作注释/标签** | 给动作添加备?| 便于维护复杂?|
| **批量调整延时** | 选中多个动作统一 +50ms / -50ms | 提升编辑效率 |
| **动作模板** | 一键插入常用组合（Click+Wait 等） | 提升效率 |
| **保存?Profile** | 录制结束后保?| 持久?|

### Could（锦上添花）

| 功能 | 说明 |
|------|------|
| 时间轴视?| 可视化时间线，拖拽调整节?|
| 动作复制/粘贴 | 快捷键支?|
| 动作上下移动 | 调整顺序 |
| 录制区域限定 | 只录制特定窗?区域内的事件 |

### Won't（不做）

| 功能 | 理由 |
|------|------|
| 条件判断 / 分支 | Phase 3 |
| 像素/图像识别 | Phase 3 |
| 脚本 / DSL | Phase 4 |

## 技术要?

### 全局事件 Hook

- 使用 `rdev` crate 实现全局键鼠监听（用于录制，?Phase 1 的热键方案不同）
- macOS 需要辅助功能权?
- 事件 callback 必须轻量，实际处理交给独立线?

### Move 事件降噪策略

- 按时间采样：?N ms 最多保留一?move 事件
- 可选：按距离采样（移动超过 M 像素才记录）
- 录制结束后可二次处理（合?平滑?

### 回放引擎

- 复用 Phase 1 的执行引擎，扩展??Timeline 执行"
- 倍速通过缩放 `at_ms` 实现
- 每个动作执行?后检?Stop 信号

### 数据结构

```rust
// tap-core
pub struct Timeline {
    pub actions: Vec<TimedAction>,
}

pub struct TimedAction {
    pub at_ms: u64,        // 相对?Timeline 开始的时间
    pub action: Action,
    pub enabled: bool,
    pub note: Option<String>,
}
```

## UI 结构（扩?MVP?

```
┌──────────────────────────────────────────────────────────────?
?Topbar: tap | [🔴 Record] [?Play] [⏸] [⏹] | 倍? [1x ▾]   ?
├────────────────┬─────────────────────────────────────────────?
?左栏: Profiles ?中栏: Timeline Editor                       ?
?- Recent       ?┌────────────────────────────────────────? ?
?- Templates    ??0ms   Click @ (640, 360)         [☑]  ? ?
?               ??500ms Wait 500ms                  [☑]  ? ?
?               ??1200ms KeyTap "Space"             [☑]  ? ?
?               ??...                                    ? ?
?               ?└────────────────────────────────────────? ?
?               ?[+ Add] [🗑 Delete] [Delay +50ms]            ?
├────────────────┴─────────────────────────────────────────────?
?录制状? 🔴 Recording | 12.3s | 42 events | Move 采样: 50ms ?
├──────────────────────────────────────────────────────────────?
?Statusbar: ⚠️ 紧急停? Ctrl+Shift+Backspace                 ?
└──────────────────────────────────────────────────────────────?
```

## 验收标准

- [ ] **录制完整?*：能录制 click/move/scroll/keydown/keyup
- [ ] **回放一致?*：回放结果与录制时的操作基本一致（允许 ±50ms 误差?
- [ ] **可编?*：能删除/禁用/调整延时
- [ ] **可停?*：录制和回放都能随时停止
- [ ] **跨平?*：Win + mac 都能正常录制和回?
- [ ] **性能**：录?5 分钟的操作不卡顿，Timeline 加载/保存 < 1s

## 里程?

| 里程?| 内容 | 状?|
|--------|------|------|
| M2.1 | 全局事件 Hook（Win + mac?| ?已完?|
| M2.2 | 录制引擎 + Move 降噪 | ?已完?|
| M2.3 | Timeline 数据结构 + 序列?| ?已完?|
| M2.4 | 回放引擎扩展（倍?循环?| ?已完?|
| M2.5 | Timeline 列表视图 + 基础编辑 | ?已完?|
| M2.6 | 录制 UI 反馈 | ?已完?|
| M2.7 | Profile 管理（保?加载/删除?| ?已完?|
| M2.8 | 稳定性测?+ 文档 | 待验?|


