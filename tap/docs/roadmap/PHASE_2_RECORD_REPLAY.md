# Phase 2 - Record & Replay（录制与回放）

## 阶段目标

> **让用户能"录一段操作、改一下、一键重放"，把 tap 从"重复器"升级为"宏工作室"。**

这是 tap 核心能力的奠基阶段：录制生成 Timeline，编辑调整节奏，回放执行。

## 前置条件

- Phase 1 已完成，安全停止机制稳定

## 功能范围

### Must（必做）

| 功能 | 说明 | 验收标准 |
|------|------|----------|
| **全局事件录制** | 录制鼠标（move/click/scroll）、键盘（keydown/keyup） | 支持 Win + mac |
| **事件时间戳** | 每个事件记录相对时间（ms） | 精度 ≤ 10ms |
| **录制控制** | Record / Pause / Stop | 三态切换正确 |
| **录制结束生成 Timeline** | 生成可编辑的 Timeline 数据结构 | 与 tap-core 数据模型一致 |
| **Move 事件降噪** | 连续 move 采样/合并 | 可配置采样率（默认 50ms） |
| **Timeline 列表视图** | 显示动作列表，支持选中/删除/禁用 | 基础编辑能力 |
| **动作延时调整** | 修改单个动作的延时 | 支持 +/- 微调 |
| **回放引擎** | 按 Timeline 执行 | 支持循环、倍速 |
| **回放倍速** | 0.5x / 1x / 2x | 实际延时按比例缩放 |
| **回放循环** | 执行 N 次 / Forever | 可配置 |

### Should（强烈建议）

| 功能 | 说明 | 理由 |
|------|------|------|
| **录制中 UI 反馈** | 显示录制时长、事件数、采样率 | 让用户知道"在录" |
| **动作注释/标签** | 给动作添加备注 | 便于维护复杂宏 |
| **批量调整延时** | 选中多个动作统一 +50ms / -50ms | 提升编辑效率 |
| **动作模板** | 一键插入常用组合（Click+Wait 等） | 提升效率 |
| **保存为 Profile** | 录制结束后保存 | 持久化 |

### Could（锦上添花）

| 功能 | 说明 |
|------|------|
| 时间轴视图 | 可视化时间线，拖拽调整节奏 |
| 动作复制/粘贴 | 快捷键支持 |
| 动作上下移动 | 调整顺序 |
| 录制区域限定 | 只录制特定窗口/区域内的事件 |

### Won't（不做）

| 功能 | 理由 |
|------|------|
| 条件判断 / 分支 | Phase 3 |
| 像素/图像识别 | Phase 3 |
| 脚本 / DSL | Phase 4 |

## 技术要点

### 全局事件 Hook

- 使用 `rdev` crate 实现全局键鼠监听（用于录制，与 Phase 1 的热键方案不同）
- macOS 需要辅助功能权限
- 事件 callback 必须轻量，实际处理交给独立线程

### Move 事件降噪策略

- 按时间采样：每 N ms 最多保留一个 move 事件
- 可选：按距离采样（移动超过 M 像素才记录）
- 录制结束后可二次处理（合并/平滑）

### 回放引擎

- 复用 Phase 1 的执行引擎，扩展为"按 Timeline 执行"
- 倍速通过缩放 `at_ms` 实现
- 每个动作执行前/后检查 Stop 信号

### 数据结构

```rust
// tap-core
pub struct Timeline {
    pub actions: Vec<TimedAction>,
}

pub struct TimedAction {
    pub at_ms: u64,        // 相对于 Timeline 开始的时间
    pub action: Action,
    pub enabled: bool,
    pub note: Option<String>,
}
```

## UI 结构（扩展 MVP）

```
┌──────────────────────────────────────────────────────────────┐
│ Topbar: tap | [🔴 Record] [▶ Play] [⏸] [⏹] | 倍速: [1x ▾]   │
├────────────────┬─────────────────────────────────────────────┤
│ 左栏: Profiles │ 中栏: Timeline Editor                       │
│ - Recent       │ ┌────────────────────────────────────────┐  │
│ - Templates    │ │ 0ms   Click @ (640, 360)         [☑]  │  │
│                │ │ 500ms Wait 500ms                  [☑]  │  │
│                │ │ 1200ms KeyTap "Space"             [☑]  │  │
│                │ │ ...                                    │  │
│                │ └────────────────────────────────────────┘  │
│                │ [+ Add] [🗑 Delete] [Delay +50ms]            │
├────────────────┴─────────────────────────────────────────────┤
│ 录制状态: 🔴 Recording | 12.3s | 42 events | Move 采样: 50ms │
├──────────────────────────────────────────────────────────────┤
│ Statusbar: ⚠️ 紧急停止: Ctrl+Shift+Backspace                 │
└──────────────────────────────────────────────────────────────┘
```

## 验收标准

- [ ] **录制完整性**：能录制 click/move/scroll/keydown/keyup
- [ ] **回放一致性**：回放结果与录制时的操作基本一致（允许 ±50ms 误差）
- [ ] **可编辑**：能删除/禁用/调整延时
- [ ] **可停止**：录制和回放都能随时停止
- [ ] **跨平台**：Win + mac 都能正常录制和回放
- [ ] **性能**：录制 5 分钟的操作不卡顿，Timeline 加载/保存 < 1s

## 里程碑

| 里程碑 | 内容 | 状态 |
|--------|------|------|
| M2.1 | 全局事件 Hook（Win + mac） | ✅ 已完成 |
| M2.2 | 录制引擎 + Move 降噪 | ✅ 已完成 |
| M2.3 | Timeline 数据结构 + 序列化 | ✅ 已完成 |
| M2.4 | 回放引擎扩展（倍速/循环） | ✅ 已完成 |
| M2.5 | Timeline 列表视图 + 基础编辑 | ✅ 已完成 |
| M2.6 | 录制 UI 反馈 | ✅ 已完成 |
| M2.7 | Profile 管理（保存/加载/删除） | ✅ 已完成 |
| M2.8 | 稳定性测试 + 文档 | ✅ 已完成 |
