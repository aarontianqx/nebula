# Phase 4 - Extensibility（可编程与插件）

## 阶段目标

> **让 tap 成为"可扩展的宏平台"：支持配置式 DSL、自定义脚本、第三方插件。**

这是 tap 的"开放生态"阶段：让用户可以超越 GUI 的能力边界，用代码/配置/插件实现更复杂的自动化。

## 前置条件

- Phase 3 已完成，条件与分支稳定

## 功能范围

### Must（必做）

| 功能 | 说明 | 验收标准 |
|------|------|----------|
| **宏导出为 DSL** | 导出为 JSON/YAML 格式 | 可用文本编辑器修改 |
| **DSL 导入** | 从 JSON/YAML 导入宏 | 格式校验 + 错误提示 |
| **DSL 语法文档** | 完整的格式说明 | 用户可自行编写 |
| **宏模板市场（本地）** | 预置模板 + 用户模板目录 | 可导入/导出 |

### Should（强烈建议）

| 功能 | 说明 | 理由 |
|------|------|------|
| **参数化宏** | 宏中的坐标/文本等可作为变量 | 复用性 |
| **运行前参数输入** | 执行前弹出表单填入变量 | 便捷性 |
| **宏组合（调用子宏）** | 一个宏可以调用另一个宏 | 模块化 |
| **内嵌轻脚本** | 简单表达式（计数器运算、字符串拼接） | 灵活性 |

### Could（锦上添花）

| 功能 | 说明 |
|------|------|
| Wasm 插件系统 | 第三方扩展动作类型/条件类型 |
| 插件 API 文档 | 开发者可自行编写插件 |
| 插件市场（远程） | 在线发现/安装插件 |
| 脚本语言集成（rhai） | 更强大的内嵌脚本能力 |

### Won't（不做）

| 功能 | 理由 |
|------|------|
| 完整编程语言（Python/JS 嵌入） | 复杂度过高，安全风险 |
| 企业级流程编排 | 超出 tap 定位 |
| 云端同步 | 后续可考虑 |

## 技术要点

### DSL 格式设计

建议使用 YAML（可读性好）+ JSON Schema（校验）：

```yaml
name: Auto Login
description: Automatically login to the app
version: "1.0"
author: user

variables:
  username: ""
  password: ""

timeline:
  - at_ms: 0
    action:
      type: click
      x: 100
      y: 200
  - at_ms: 500
    action:
      type: text_input
      text: "{{ username }}"
  - at_ms: 1000
    action:
      type: key_tap
      key: Tab
  - at_ms: 1200
    action:
      type: text_input
      text: "{{ password }}"
  - at_ms: 1500
    condition:
      type: pixel_color
      x: 300
      y: 400
      color: "#00FF00"
      tolerance: 10
    then:
      type: click
      x: 500
      y: 600
    else:
      type: quit

run:
  repeat: 1
  start_delay_ms: 3000
  speed: 1.0
```

### 参数化与变量

- 变量定义在宏头部
- 引用语法：`{{ variable_name }}`
- 执行前弹出表单，或从命令行传入

### 内嵌表达式

- 使用 `rhai` crate（轻量级 Rust 脚本引擎）
- 仅用于简单计算/字符串处理
- 沙箱执行，禁止文件/网络访问

### Wasm 插件系统

- 使用 `wasmtime` 或 `extism` 作为运行时
- 定义插件 ABI：
  - `register_actions()` - 注册自定义动作
  - `register_conditions()` - 注册自定义条件
  - `execute(action_id, params)` - 执行动作
  - `evaluate(condition_id, params)` - 评估条件
- 插件以 `.wasm` 文件分发

### 安全边界

- 插件运行在沙箱中，无文件/网络访问（除非显式授权）
- 内嵌脚本禁止 I/O
- 用户安装插件需确认权限

## UI 结构（扩展 Phase 3）

```
┌──────────────────────────────────────────────────────────────┐
│ Topbar: tap | [▶ Run] | [📄 Export] [📥 Import]             │
├────────────────┬─────────────────────────────────────────────┤
│ 左栏           │ 中栏: Timeline Editor                       │
│ - Profiles     │ (同 Phase 3)                                │
│ - Templates    │                                             │
│ - Plugins      │ ┌────────────────────────────────────────┐  │
│   ├ OCR        │ │ 变量: username = [__________]          │  │
│   ├ Web Request│ │        password = [**********]          │  │
│   └ ...        │ └────────────────────────────────────────┘  │
├────────────────┼─────────────────────────────────────────────┤
│ 代码视图       │ YAML / JSON 源码编辑（可选 tab）            │
│                │ ┌────────────────────────────────────────┐  │
│                │ │ name: Auto Login                       │  │
│                │ │ timeline:                              │  │
│                │ │   - at_ms: 0                           │  │
│                │ │     action:                            │  │
│                │ │       type: click                      │  │
│                │ │ ...                                    │  │
│                │ └────────────────────────────────────────┘  │
├────────────────┴─────────────────────────────────────────────┤
│ Statusbar: Plugins: 3 loaded | ⚠️ Ctrl+Shift+Backspace      │
└──────────────────────────────────────────────────────────────┘
```

## 验收标准

- [x] **DSL 导出/导入**：能正确导出/导入宏
- [x] **变量替换**：参数化宏能正确替换变量
- [x] **格式校验**：无效 DSL 给出清晰错误提示
- [x] **表达式引擎**：Rhai 沙箱表达式求值
- [ ] **子宏调用**：框架已实现（submacro.rs），待集成到 Engine
- [ ] **插件加载**：能加载 Wasm 插件并执行（延后到 Phase 5）
- [ ] **安全隔离**：插件无法访问未授权资源（延后到 Phase 5）

## 里程碑

| 里程碑 | 内容 | 状态 |
|--------|------|------|
| M4.1 | DSL 格式设计 + 导出 | ✅ 完成 |
| M4.2 | DSL 导入 + 校验 | ✅ 完成 |
| M4.3 | 参数化宏 + 变量替换 | ✅ 完成 |
| M4.4 | 子宏调用框架 | ⚠️ 框架完成，Engine 集成待做 |
| M4.5 | 内嵌表达式（rhai） | ✅ 完成 |
| M4.6 | Tauri 命令层 | ✅ 完成 |
| M4.7 | 前端 UI（导入/导出/代码视图） | ✅ 完成 |
| M4.8 | 文档 + 模板库 | ✅ 完成 |

### 待完成项

| 功能 | 说明 | 计划 |
|------|------|------|
| CallMacro 执行 | 在 Engine 中实现子宏调用执行 | 后续迭代 |
| 变量替换在执行时生效 | 当前 DSL 可定义变量但执行时替换未完全集成 | 后续迭代 |
| Wasm 插件系统 | 原 M4.6-M4.7 内容 | Phase 5 |

> **说明**：Phase 4 的核心目标（DSL 导出/导入、变量定义、表达式引擎）已完成。子宏调用的框架代码（`submacro.rs`）已就绪，但 Engine 中的执行集成作为后续增强。

## 长期愿景

Phase 4 完成后，tap 将成为：

1. **对普通用户**：开箱即用的桌面自动化工具
2. **对进阶用户**：可用 YAML/JSON 编写宏的强大工具
3. **对开发者**：可扩展的自动化平台（Wasm 插件生态）


