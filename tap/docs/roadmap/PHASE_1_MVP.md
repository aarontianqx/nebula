# Phase 1 - MVP（最小可用产品）

## 阶段目标

> **让用户能在 1 分钟内跑通"安全的重复点击"，并明确知道"如何停下来"。**

这是 tap 的"第一印象"阶段：必须简单、稳定、可控。不追求功能丰富，追求"用过之后放心"。

## 功能范围

### Must（必做）

| 功能 | 说明 | 验收标准 |
|------|------|----------|
| **固定坐标点击** | 设置 x/y，间隔 N ms，循环执行 | 能稳定执行 1000+ 次无卡死 |
| **按键重复** | 设置键位，间隔 N ms，循环执行 | 支持常用修饰键组合 |
| **Start / Pause / Stop** | 基础控制 | UI 状态与执行状态一致 |
| **全局紧急停止热键** | 默认 `Ctrl+Shift+Backspace`（可配置） | 任意焦点下 100ms 内响应 |
| **开始前倒计时** | 3..2..1，用户可切换到目标窗口 | 可配置秒数（默认 3s） |
| **执行状态可视化** | 显示：下一步动作、剩余时间、已执行次数 | 实时更新，延迟 < 200ms |
| **基础 Profile 持久化** | 保存/加载当前配置 | JSON 格式，支持重启后恢复 |
| **权限检查（mac）** | 辅助功能权限检测与引导 | 权限缺失时禁用功能并提示 |

### Should（强烈建议）

| 功能 | 说明 | 理由 |
|------|------|------|
| **坐标拾取器** | 点击"Pick"进入拾取模式，用户在**任意屏幕位置**点击后自动填入坐标 | 用户不知道具体坐标，只知道"点哪里" |
| **鼠标实时位置显示** | 配置区显示当前鼠标的**全屏坐标**（即使鼠标在窗口外） | 辅助用户确认位置 |
| **目标窗口提示** | 显示"当前前台窗口"的标题/进程名 | 帮助用户确认操作对象 |
| **简易日志面板** | 显示近期事件（启动/停止/错误） | 便于排查问题 |
| **最近使用记录** | 显示最近打开的 Profile | 提升效率 |
| **循环次数设置** | 执行 N 次后自动停止 | 避免无限执行 |

### Could（锦上添花）

| 功能 | 说明 |
|------|------|
| 随机抖动（坐标/延时） | 小范围随机，降低机械感 |
| 最小化到托盘 | 后台运行时不占任务栏 |
| 深色/浅色主题切换 | 用户偏好 |

### Won't（不做）

| 功能 | 理由 |
|------|------|
| 录制功能 | Phase 2 |
| 条件判断 / 分支 | Phase 3 |
| 插件 / 脚本 | Phase 4 |
| 多窗口 / 多 Profile 并行执行 | 复杂度过高，后续考虑 |

## 技术要点

### 输入注入

- 使用 `enigo` crate
- macOS 需要辅助功能权限

### 全局热键

- 使用 `tauri-plugin-global-shortcut`（Tauri v2 插件）
- 注册在 Tauri setup 阶段，由系统原生热键机制处理
- 响应后通过 IPC 通知前端

### 全局坐标系统

> tap 是全屏自动化工具，坐标必须基于整个屏幕，而非 WebView 窗口内部。

- **全局鼠标位置**：通过后端 `rdev` 监听全屏 MouseMove 事件，推送给前端
- **坐标拾取器**：通过创建**全屏透明覆盖窗口**实现
  - 用户点击"Pick"后，打开一个全屏透明置顶窗口
  - 窗口显示半透明遮罩 + 十字准星 + 实时坐标
  - 点击被窗口捕获，不会穿透到其他应用
  - 类似截图软件的实现方式，无需系统级 hook
- **高 DPI 支持**：进程启动时设置 Per-Monitor V2 DPI Awareness，确保物理像素坐标一致性
- **不能依赖 DOM 事件**：WebView 的 `mousemove` / `click` 只能捕获窗口内事件

### 执行引擎

- 独立线程执行，通过 channel 接收 Start/Pause/Stop 信号
- 执行循环必须高频检查 Stop 信号（每个动作前/后）
- 失败 N 次（默认 3 次）自动停止

### 状态机

```
Idle → Arming (countdown) → Running ⇄ Paused → Idle (stopped)
              ↑                 │
              └─────────────────┘ (Emergency Stop)
```

## UI 结构（MVP 简化版）

```
┌──────────────────────────────────────────────┐
│ Topbar: tap | [▶ Run] [⏸ Pause] [⏹ Stop]    │
├──────────────────────────────────────────────┤
│ 配置区:                                       │
│  - 动作类型: [Click ▾] / [Key ▾]              │
│  - 坐标: X [___] Y [___] [🎯 Pick] / 键位: [___] │
│  - 间隔: [___] ms                            │
│  - 循环: [___] 次 / [∞ Forever]              │
├──────────────────────────────────────────────┤
│ 状态区:                                       │
│  - 状态: Idle / Arming (3..2..1) / Running   │
│  - 下一动作: Click @ (640, 360) in 500ms     │
│  - 已执行: 42 / 100                          │
├──────────────────────────────────────────────┤
│ 日志区: (可折叠)                              │
│  - 14:32:01 Started                          │
│  - 14:32:04 Click @ (640, 360)               │
│  - ...                                       │
├──────────────────────────────────────────────┤
│ Statusbar: ⚠️ 紧急停止: Ctrl+Shift+Backspace │
└──────────────────────────────────────────────┘
```

## 验收标准

- [ ] **稳定性**：连续执行 1000 次点击无崩溃、无卡死
- [ ] **可停止性**：任意时刻按紧急停止热键，100ms 内停止
- [ ] **跨平台**：Win 和 mac 上都能正常运行（mac 需权限引导）
- [ ] **可恢复**：异常退出后重启，能加载上次的 Profile
- [ ] **可观测**：执行过程中 UI 实时显示状态，日志可追溯

## 里程碑

| 里程碑 | 内容 | 状态 |
|--------|------|------|
| M1.1 | 项目骨架 + Tauri IPC 打通 | ✅ 已完成 |
| M1.2 | 输入注入基础能力（Win） | ✅ 已完成 |
| M1.3 | 执行引擎 + 状态机 | ✅ 已完成 |
| M1.4 | 全局热键（紧急停止） | ✅ 已完成 |
| M1.5 | UI 完整交互 | ✅ 已完成 |
| M1.6 | macOS 适配 + 权限引导 | 待验证 |
| M1.7 | Profile 持久化 | ✅ 已完成 |
| M1.8 | 稳定性测试 + 文档 | ✅ 已完成 |


