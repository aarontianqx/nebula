# tap - UI / UX 设计说明

## 设计目标

tap 是一个“会执行你的手”的工具：它的 UX 目标不是花哨，而是**可靠、可控、可预期、可恢复**。长期自用的体验优化优先级如下：

1. **安全与可停止**：任何时候都能立刻停下（全局紧急停止、可视化状态、超时保护）
2. **高信息密度但不压迫**：能快速看清“将要做什么/正在做什么/为什么停”
3. **低门槛与可成长**：从“重复点击”起步，逐步引导到“录制/编辑/条件/脚本/插件”
4. **可维护性**：UI 结构清晰、可扩展、可替换，不把业务逻辑绑死在前端

## 核心信息架构（IA）

建议采用“三栏 + 底部状态栏”的结构：

```
┌──────────────────────────────────────────────────────────┐
│ Topbar: 当前宏 | 运行按钮 | 目标窗口 | 热键提示 | 设置入口 │
├───────────────┬───────────────────────────────┬──────────┤
│ 左栏: Profiles │ 中栏: Timeline Editor         │ 右栏:    │
│ - 最近使用      │ - 录制轨道/动作列表/时间轴     │ Inspector│
│ - 模板/收藏      │ - 条件/分支（后期）            │ - 坐标/键│
│ - 标签筛选      │                               │ - 目标窗口│
├───────────────┴───────────────────────────────┴──────────┤
│ Statusbar: 状态机 + 近期事件（可展开日志抽屉）            │
└──────────────────────────────────────────────────────────┘
```

## 关键交互流程

### 1) 第一次使用（Onboarding）

目标：让用户在 1 分钟内跑通一次“安全的重复点击”，并明确“如何停下来”。

- 第一步：展示"紧急停止热键"（默认 `Ctrl+Shift+Backspace`，可改）
- 第二步：引导“选择目标窗口/屏幕区域”（最小可先做“倒计时 + 用户手动切窗口”）
- 第三步：创建一个“点击 + wait”示例宏，一键运行
- 第四步：在 UI 明显位置展示：
  - **Running** 状态
  - 下一步动作倒计时
  - 已执行次数
  - （可选工具）**Key→Click**：提示“按住 A–Z 连点、Space 停止”，作为鼠标连点替代方案

### 2) 录制（Record）

录制的体验必须“可控”：

- 录制按钮必须有三态：Record / Pause / Stop
- UI 必须显示：
  - 录制时长
  - 事件数（move/click/key）
  - “降噪策略”提示（例如 move 采样率）
- Stop 后弹出“保存为宏”的对话框：名称、标签、备注

### 3) 回放（Replay）

回放必须“可预期”：

- 支持开始前倒计时（3..2..1），允许用户切换到目标窗口
- 运行时展示：
  - 当前动作（高亮）
  - 下一动作与剩余时间
  - 当前循环/总循环（或 Forever）
- 支持 Pause（暂停）与 Stop（终止并回到 Idle）

## 安全与可停止性（必须做成一等公民）

### 状态机（建议）

```
Idle → Arming → Running → Paused
  ↑        │        │        │
  └────────┴────────┴────────┘ (Stop / Emergency Stop)
```

### 必备安全机制

- **全局紧急停止**：无论窗口焦点在哪都生效
- **安全阈值**：
  - 连续注入失败 N 次自动停止
  - 单次宏运行超过上限时长提示（可选自动停止）
- **可恢复**：
  - 崩溃/异常后提示“上次运行中断”，可查看日志与恢复宏

## 权限与平台差异（Win + mac）

macOS 对“全局监听/输入注入”可能需要辅助功能权限：

- UI 需要“权限检查页”
- 以清晰、可复制的步骤引导用户开启权限
- 权限缺失时：
  - 禁用录制/回放按钮
  - 给出明确原因与“去设置”按钮

Windows 侧重点：

- 目标应用可能是管理员权限；必要时提示“以管理员运行 tap”

## 编辑器体验（Timeline Editor）

长期自用的核心竞争力是“编辑器舒服”：

- **两种视图**：
  - 列表视图（易读、易编辑参数）
  - 时间轴视图（易理解节奏、拖拽调整）
- **动作卡片**：
  - 类型图标 + 关键参数（坐标/键/文本/延时）
  - 启用/禁用开关
  - 备注
- **常用操作快捷键**：
  - 复制/粘贴动作
  - 上下移动
  - 批量调整延时（+50ms / -50ms）

## 模板与复用

为了长期维护和自用效率：

- 内置模板/工具：Repeat Click、Spam Key、**Key→Click（按住 A–Z 连点，Space 停）**、Record & Replay、Drag Loop
- 支持“参数化宏”（后期）：把坐标/文本作为变量，运行前填入
- 支持导入/导出（JSON/YAML）

## 视觉风格

建议走"工具型现代 UI"：

- 深色为默认（高对比但不过亮）
- 清晰的层级与间距（避免拥挤）
- Running 状态突出显示（但避免刺眼红色常驻）

## 全局坐标系统

> tap 是全屏自动化工具，不是"窗口内"应用。

**核心原则**：所有鼠标坐标基于**整个屏幕的物理像素**，而非 WebView 内部相对坐标。

**UI 设计约束**：

1. **实时鼠标位置显示**：即使鼠标移出窗口，仍需显示全屏坐标
   - 通过后端 `rdev` 监听全局 MouseMove 事件实现
   - 前端不依赖 DOM `mousemove` 事件

2. **坐标拾取器**：用户点击"Pick"后，可以点击屏幕**任意位置**
   - 点击窗口外的位置也能正确捕获
   - 通过创建**全屏透明覆盖窗口**实现（类似截图软件）
   - 覆盖窗口显示半透明遮罩 + 十字准星 + 实时坐标
   - 点击不会穿透到其他应用，避免误触
   - ESC 键可取消拾取

3. **高 DPI 屏幕**：在 4K + 缩放环境下坐标一致
   - 进程启动时设置 Per-Monitor V2 DPI Awareness
   - 录制和回放使用相同的物理像素坐标系

**为什么不能用 DOM 事件？**

- WebView 的 `mousemove` / `click` 只能捕获窗口内部事件
- 鼠标移出窗口后，WebView 收不到事件
- 用户点击窗口外时，实际点击的是其他应用或桌面


