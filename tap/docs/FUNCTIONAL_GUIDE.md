# tap - 功能说明

## 概述

tap（Timed Action Performer）是一款面向桌面环境的自动化工具，用于执行“按时间编排的一系列动作（Timed Actions）”。它从最简单的重复点击开始，逐步演进为可录制、可编辑、可回放、可扩展的“宏（Macro）工作室”。

tap 的目标不是替代专业 RPA 平台，而是提供**更轻量、低门槛、可持续扩展**的自动化能力，覆盖大量个人/小团队的重复性操作场景。

## 产品原则（长期自用导向）

1. **可控优先**：永远有“停下来”的办法（紧急停止热键、清晰状态、超时/失败保护）。
2. **可预期优先**：让用户随时知道“接下来会发生什么”。
3. **可恢复优先**：崩溃/权限缺失/目标窗口变化时，给出明确提示与恢复路径。
4. **从简单到强大**：功能按“重复 → 录制 → 编辑 → 条件 → 脚本 → 插件”逐级打开。
5. **跨平台一致**：Win + mac 提供一致的操作模型，但把平台差异显式化（权限、热键、注入限制）。

## 目标用户与使用场景

### 目标用户

- 需要频繁重复桌面操作的个人用户（游戏、运营、表单录入、测试回归等）
- 需要用“录制 + 小改动”快速做批处理操作的轻量自动化用户
- 未来：愿意写一点点配置/脚本/插件来实现更强自动化的进阶用户

### 典型场景

- 重复点击/重复按键：每隔 N 秒点击某点、按某键
- 录制与重放：录一段鼠标键盘操作，之后一键重放
- 批量流程：打开应用 → 登录 → 点菜单 → 填表 → 保存（后续逐步增强）

## 核心概念

### 1. Action（动作）

动作是最小执行单元，例如：

- click / double-click / right-click
- key tap / key down / key up
- wait（延时）
- drag（拖拽）
- text input（文本输入）

### 2. Timeline（时间线）

时间线是动作序列，包含“每个动作的相对时间/延迟”。tap 的核心抽象是：

> 把“手的操作”转换为“可编辑的时间线”，再由执行引擎稳定执行。

### 3. Profile / Macro（配置/宏）

一个 Profile（或 Macro）包含：

- 元数据：名称、描述、标签
- 时间线：动作列表
- 执行策略：循环次数、间隔、随机抖动（anti-pattern/anti-detection）、起止条件等

## MVP（第一阶段）功能范围

### 1. 简单重复（Repeat）

提供“最小闭环”的重复执行能力：

- **固定坐标点击**：设置 x/y，间隔 N ms，循环执行
- **按键重复**：设置键位，间隔 N ms
- **基本控制**：Start / Pause / Stop
- **安全停止**：全局热键（例如 `Ctrl+Shift+Backspace`）立即停止

> 说明：MVP 先追求可靠与可用，复杂编排与录制在下一阶段。

#### 体验增强（MVP 也建议做）

- **开始前倒计时**：3..2..1，方便用户切到目标窗口。
- **目标窗口提示**：显示“当前目标窗口（或前台窗口）”的标题/进程名（可先做只读提示）。
- **执行可视化**：在 UI 中显示“下一步动作 + 剩余时间 + 已执行次数”。
- **一键安全停止**：显眼的 Stop + 全局紧急停止热键（默认组合键，可配置）。

### 2. 基础配置与持久化

- 保存/加载 Profile
- 最近使用记录（最近打开的宏）

### 3. 基础可观测性

- 简易日志面板（近期事件）
- 错误提示（权限不足、Hook 失败、模拟输入失败等）

## 第二阶段（录制/重放）

### 1. 录制（Record）

- 记录鼠标移动、点击、滚轮、键盘按键
- 记录事件时间戳（用于回放的节奏）
- 录制过程可暂停/继续
- 录制结束生成 Timeline

### 2. 编辑（Edit）

最低限度的编辑能力：

- 删除/禁用某个动作
- 调整动作延时
- 合并连续 move 事件（降噪）
- 对动作添加“注释/标签”

#### 体验增强（决定长期好不好用）

- **两种视图**：动作列表视图 + 时间轴视图（拖拽调整节奏）。
- **动作模板化**：常用动作一键插入（Click+Wait、Key spam 等）。
- **批量调整**：选中多个动作统一 +50ms / -50ms / 倍速缩放。

### 3. 回放（Replay）

- 按时间线执行
- 支持倍速（0.5x / 1x / 2x）
- 支持循环 N 次
- 支持“开始前倒计时”

## 第三阶段（条件、识别与更强编排）

在"时间线"之外，加入"条件"和"分支"能力：

- **窗口绑定**：宏绑定到特定窗口（标题/进程名），运行时自动校验；不匹配则暂停并提示
- **像素颜色检测**：检测某坐标颜色是否匹配（支持 RGB 容差）
- **简单分支**：if/else 条件执行，WaitUntil 等待条件满足
- **变量与计数器**：incr/decr/reset/set，用于循环控制和退出条件
- **超时保护**：等待条件超时后执行备选动作或停止

### 额外能力（更"有远见"的需求判断）

以下能力非常实用，且不会把 tap 变成"企业 RPA"：

- **相对坐标**：坐标相对于目标窗口而非屏幕，提升跨分辨率稳定性
- **随机抖动（可控）**：对点击坐标/延时做小范围随机（可配置）
- **速率限制与防抖**：避免过快输入导致目标应用卡死或误触

## 第四阶段（可编程 / 插件）

### 1. 配置式 DSL

支持用 YAML DSL 描述宏（GUI 只是编辑器/可视化）：

- 便于版本管理
- 便于分享与复用
- 便于自动生成/批量修改
- 参数化变量（`{{ var }}` 语法）

详见 [DSL 参考](./DSL_REFERENCE.md)

### 2. 内嵌轻脚本

用于表达少量条件/计算（例如计数器、字符串拼接）：

- 表达式语法：`{{ counter + 1 }}`、`{{ "prefix_" + name }}`
- 沙箱执行，禁止文件/网络访问

### 3. 子宏调用

一个宏可以调用另一个宏，实现模块化：

- 调用栈管理，防止循环调用
- 变量上下文共享

### 4. 插件系统（演进目标）

插件用于扩展：

- 动作类型（例如 OCR、窗口管理、Web 请求）
- 条件判断（例如识别某 UI 状态）
- 自定义面板（可选）

建议路线：Wasm 插件（安全隔离、跨平台、生态成熟）。

### 脚本层的"性价比路线"

长期维护的角度，建议按以下顺序演进：

1. **配置式 DSL（GUI 生成）**：覆盖 80% 的需求，降低脚本错误风险
2. **内嵌轻脚本（可选）**：用于表达少量条件/计算
3. **Wasm 插件**：用于扩展动作类型与复杂逻辑

## 非目标（短期不做）

- 企业级 RPA：复杂流程编排、流程监控、集中管理
- 通用跨设备自动化：移动端自动化（另起项目）
- 过度侵入式“反检测”能力：tap 以合法与用户自用为前提

## 风险与注意事项

1. **权限与安全**：全局输入 Hook / 输入模拟在不同 OS 上有权限要求（macOS 辅助功能权限等）。
2. **可靠性**：必须提供一键停止与“卡死保护”机制。
3. **可预期性**：录制的 move 事件噪声巨大，必须做压缩/抽样策略。
4. **目标变化**：目标应用更新 UI/分辨率变化会导致坐标偏移，需要 ROI/相对坐标/校验机制降低维护成本。


